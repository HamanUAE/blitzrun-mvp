console.log('BlitzRun app.js loaded');

const $ = (id) => document.getElementById(id);

// IDs المستخدمة في HTML:
// coins, airdrop, todayCount
// btn-run, btn-jump, btn-sync
// walletInput, btn-save-wallet
// refLink, btn-copy

// إعدادات عامة
const DAILY_CAP = 5000;
let coins = parseInt(localStorage.getItem('br_coins') || '0', 10);
let today = parseInt(localStorage.getItem('br_today') || '0', 10);
let userId = localStorage.getItem('br_uid') || crypto.randomUUID();
localStorage.setItem('br_uid', userId);

// تقدير الأيردروب: كل 1000 = 20
function estAirdrop(c) { return Math.floor(c / 1000) * 20; }

function render() {
if ($('coins')) $('coins').textContent = coins;
if ($('airdrop')) $('airdrop').textContent = estAirdrop(coins);
if ($('todayCount')) $('todayCount').textContent = `${today}/${DAILY_CAP}`;
if ($('refLink')) $('refLink').value = `${location.origin}${location.pathname}?r=${encodeURIComponent(userId)}`;
}

function add(amount) {
const canAdd = Math.min(amount, Math.max(0, DAILY_CAP - today));
if (canAdd <= 0) { alert('Daily cap reached'); return; }
today += canAdd;
coins += canAdd;
localStorage.setItem('br_coins', String(coins));
localStorage.setItem('br_today', String(today));
render();
}

// حفظ المحفظة محلياً (MVP)
function saveWallet() {
const v = ($('walletInput')?.value || '').trim();
if (!v) return alert('Enter your Phantom address');
localStorage.setItem('br_wallet', v);
alert('Wallet saved (local)');
}

// نسخ رابط الإحالة
function copyRef() {
if (!$('refLink')) return;
$('refLink').select?.();
navigator.clipboard.writeText($('refLink').value);
alert('Copied!');
}

// --- ربط الأزرار بعد بناء الـDOM ---
document.addEventListener('DOMContentLoaded', () => {
$('btn-run')?.addEventListener('click', () => add(10));
$('btn-jump')?.addEventListener('click', () => add(25));
$('btn-sync')?.addEventListener('click', () => alert('Sync (test). شغالين أولاً محلياً — نفعل Supabase بعد ما تتأكد الأزرار تعمل.'));
$('btn-save-wallet')?.addEventListener('click', saveWallet);
$('btn-copy')?.addEventListener('click', copyRef);
render();
});
